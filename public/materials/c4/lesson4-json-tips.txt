טיפים וטריקים לעבודה עם JSON Mode
===================================

טיפים מתקדמים לשימוש יעיל
============================

1. יצירת Schema דינמי
======================

במקום לכתוב Schema ידנית, אפשר ליצור אותו דינמית:

```python
def create_product_schema(include_price=True, include_specs=False):
    schema = {
        "type": "object",
        "properties": {
            "name": {"type": "string"},
            "description": {"type": "string"}
        },
        "required": ["name", "description"]
    }
    
    if include_price:
        schema["properties"]["price"] = {"type": "number"}
        schema["required"].append("price")
    
    if include_specs:
        schema["properties"]["specifications"] = {
            "type": "object",
            "properties": {
                "weight": {"type": "string"},
                "dimensions": {"type": "string"}
            }
        }
    
    return schema

# שימוש
schema = create_product_schema(include_price=True, include_specs=True)
```

2. Validation מתקדם
====================

הוסף validation מותאם אישית:

```python
import jsonschema
from jsonschema import validate

def validate_response(response_text, schema):
    try:
        data = json.loads(response_text)
        validate(instance=data, schema=schema)
        return True, data
    except json.JSONDecodeError as e:
        return False, f"שגיאת JSON: {e}"
    except jsonschema.ValidationError as e:
        return False, f"שגיאת validation: {e.message}"

# שימוש
is_valid, result = validate_response(response.text, schema)
if is_valid:
    print("תקין!")
    print(result)
else:
    print(f"שגיאה: {result}")
```

3. טיפול בשגיאות
=================

הוסף retry logic לשגיאות:

```python
import time

def generate_with_retry(model, prompt, schema, max_retries=3):
    for attempt in range(max_retries):
        try:
            response = model.generate_content(
                prompt,
                generation_config={
                    "response_mime_type": "application/json",
                    "response_schema": schema
                }
            )
            data = json.loads(response.text)
            return data
        except json.JSONDecodeError:
            if attempt < max_retries - 1:
                time.sleep(1)  # המתן לפני retry
                continue
            raise
    return None
```

4. שימוש עם Type Hints
=======================

השתמש ב-TypedDict לבדיקת types:

```python
from typing import TypedDict, List

class ProductInfo(TypedDict):
    name: str
    description: str
    price: float
    features: List[str]

def parse_product_response(response_text: str) -> ProductInfo:
    data = json.loads(response.text)
    return ProductInfo(
        name=data["name"],
        description=data["description"],
        price=data["price"],
        features=data["features"]
    )
```

5. Schema מותאם לפי System Instructions
========================================

שלב System Instructions עם JSON Mode:

```python
model = genai.GenerativeModel(
    model_name="gemini-1.5-flash",
    generation_config={
        "response_mime_type": "application/json",
        "response_schema": {
            "type": "object",
            "properties": {
                "analysis": {"type": "string"},
                "recommendations": {
                    "type": "array",
                    "items": {"type": "string"}
                }
            }
        }
    },
    system_instruction="""אתה אנליסט מקצועי.
תמיד החזר ניתוח מפורט והמלצות מעשיות.
השתמש בפורמט JSON מובנה."""
)
```

6. עיבוד Arrays גדולים
========================

עבוד עם arrays גדולים ביעילות:

```python
schema = {
    "type": "object",
    "properties": {
        "items": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "id": {"type": "number"},
                    "data": {"type": "string"}
                }
            },
            "maxItems": 100  # הגבל גודל
        }
    }
}

# עיבוד chunked
def process_large_array(data, chunk_size=10):
    items = data["items"]
    for i in range(0, len(items), chunk_size):
        chunk = items[i:i+chunk_size]
        # עבד על chunk
        process_chunk(chunk)
```

7. שימוש עם Default Values
============================

השתמש ב-default values לשדות אופציונליים:

```python
def parse_with_defaults(data, schema):
    result = {}
    for field, config in schema["properties"].items():
        if field in data:
            result[field] = data[field]
        elif "default" in config:
            result[field] = config["default"]
    return result

schema = {
    "type": "object",
    "properties": {
        "name": {"type": "string"},
        "status": {
            "type": "string",
            "enum": ["active", "inactive"],
            "default": "active"
        }
    }
}
```

8. Caching של Schemas
=====================

שמור Schemas נפוצים:

```python
SCHEMA_CACHE = {}

def get_schema(schema_name):
    if schema_name not in SCHEMA_CACHE:
        SCHEMA_CACHE[schema_name] = load_schema(schema_name)
    return SCHEMA_CACHE[schema_name]

# שימוש
product_schema = get_schema("product")
user_schema = get_schema("user")
```

9. שילוב עם Error Handling
============================

הוסף error handling מקיף:

```python
class JSONModeError(Exception):
    pass

def safe_generate_json(model, prompt, schema):
    try:
        response = model.generate_content(
            prompt,
            generation_config={
                "response_mime_type": "application/json",
                "response_schema": schema
            }
        )
        
        if not response.text:
            raise JSONModeError("תגובה ריקה")
        
        data = json.loads(response.text)
        
        # בדיקת required fields
        required = schema.get("required", [])
        missing = [f for f in required if f not in data]
        if missing:
            raise JSONModeError(f"שדות חסרים: {missing}")
        
        return data
        
    except json.JSONDecodeError as e:
        raise JSONModeError(f"שגיאת JSON: {e}")
    except Exception as e:
        raise JSONModeError(f"שגיאה: {e}")
```

10. בדיקת Schema לפני שימוש
=============================

ודא שה-Schema תקין:

```python
import jsonschema

def validate_schema(schema):
    try:
        jsonschema.Draft7Validator.check_schema(schema)
        return True
    except jsonschema.SchemaError as e:
        print(f"שגיאת Schema: {e}")
        return False

# שימוש
if validate_schema(my_schema):
    # השתמש ב-Schema
    pass
```

11. יצירת Schema מתיאור טקסטואלי
===================================

צור Schema אוטומטית מתיאור:

```python
def generate_schema_from_description(description):
    prompt = f"""צור JSON Schema עבור:
{description}

החזר רק את ה-Schema ב-JSON, בלי הסברים נוספים."""

    model = genai.GenerativeModel("gemini-1.5-flash")
    response = model.generate_content(prompt)
    schema = json.loads(response.text)
    return schema

# שימוש
description = "מוצר עם שם, תיאור, מחיר ותכונות"
schema = generate_schema_from_description(description)
```

12. שימוש עם Nested Objects מורכבים
====================================

עבוד עם מבנים מורכבים:

```python
complex_schema = {
    "type": "object",
    "properties": {
        "user": {
            "type": "object",
            "properties": {
                "profile": {
                    "type": "object",
                    "properties": {
                        "personal": {
                            "type": "object",
                            "properties": {
                                "name": {"type": "string"},
                                "age": {"type": "number"}
                            }
                        },
                        "contact": {
                            "type": "object",
                            "properties": {
                                "email": {"type": "string"},
                                "phone": {"type": "string"}
                            }
                        }
                    }
                }
            }
        }
    }
}
```

טיפים כלליים
==============

1. התחל פשוט
-------------
• התחל עם Schema בסיסי
• הוסף שדות בהדרגה
• בדוק בכל שלב

2. תיעוד
----------
• תיעד את ה-Schema
• הסבר מה כל שדה
• הוסף דוגמאות

3. בדיקות
----------
• בדוק עם דוגמאות שונות
• ודא validation עובד
• בדוק edge cases

4. ביצועים
-----------
• השתמש ב-Schema קטן ככל האפשר
• הגבל arrays גדולים
• Cache Schemas נפוצים

5. אבטחה
---------
• בדוק input לפני שימוש
• Validate תמיד
• Handle errors נכון

סיכום
======

טיפים עיקריים:
✓ יצירת Schema דינמי
✓ Validation מתקדם
✓ טיפול בשגיאות
✓ שימוש עם Type Hints
✓ שילוב עם System Instructions
✓ עיבוד Arrays גדולים
✓ שימוש ב-Default Values
✓ Caching של Schemas
✓ Error Handling מקיף
✓ בדיקת Schema
✓ יצירת Schema אוטומטית
✓ עבודה עם מבנים מורכבים

זכור:
• התחל פשוט
• תיעד הכל
• בדוק תמיד
• שפר בהדרגה

---
© 2026 Google AI Academy
טיפים וטריקים לעבודה עם JSON Mode